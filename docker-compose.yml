#version: '3.8'
services:
  # --- INFRASTRUCTURE ---
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: sentinel-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - fraud-network
    healthcheck:
      test: ["CMD", "bash", "-c", "echo ruok | nc localhost 2181"]
      interval: 10s
      timeout: 5s
      retries: 5

  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: sentinel-kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks:
      - fraud-network
    healthcheck:
      test: ["CMD", "kafka-topics", "--bootstrap-server", "kafka:29092", "--list"]
      interval: 15s
      timeout: 10s
      retries: 10

  redis:
    image: redis:7-alpine
    container_name: sentinel-redis
    command: redis-server --appendonly yes --requirepass sentinel_pass_2024
    ports:
      - "6379:6379"
    networks:
      - fraud-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "sentinel_pass_2024", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # --- APPLICATION SERVICES ---

  api:
    build: 
      context: .
      dockerfile: backend/Dockerfile
    container_name: sentinel-api
    ports:
      - "8000:8000"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=sentinel_pass_2024
      - KAFKA_BOOTSTRAP_SERVERS=kafka:29092
      - MODEL_CONFIG_PATH=/app/models/production_config.json
    volumes:
      - ./models:/app/models  # ADDED: Essential for reading production_config.json
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - fraud-network
    restart: always

  stream-processor:
    build: 
      context: .
      dockerfile: worker/Dockerfile
    container_name: sentinel-worker
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:29092
      - INPUT_TOPIC=transactions
      - OUTPUT_TOPIC=predictions
      - DLQ_TOPIC=sentinel_dlq
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=sentinel_pass_2024
      - MODEL_DIR=/app/models/prod_v1
    volumes:
      - ./models:/app/models
    depends_on:
      kafka:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - fraud-network
    restart: always

  metrics-worker:
    build: 
      context: .
      dockerfile: worker/Dockerfile
    container_name: sentinel-metrics
    # This overrides the default CMD ["python", "processor.py"] in Dockerfile
    command: python metrics.py
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=sentinel_pass_2024
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - fraud-network
    restart: always

  producer:
    build: 
      context: ./simulator # Pointing to the folder containing simulator/Dockerfile
    container_name: sentinel-simulator
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:29092
      - INPUT_TOPIC=transactions
      - SIMULATION_RATE=2.0
      - DATA_FILE=/app/data/raw/test_raw.csv
    volumes:
      - ./data:/app/data
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - fraud-network
    restart: always

  dashboard:
    build: 
      context: ./dashboard # Pointing to the folder containing dashboard/Dockerfile
    container_name: sentinel-dashboard
    ports:
      - "8501:8501"
    environment:
      - BACKEND_URL=http://api:8000
    depends_on:
      api:
        condition: service_started
    networks:
      - fraud-network
    restart: always

networks:
  fraud-network:
    driver: bridge